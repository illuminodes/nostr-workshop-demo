<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <script src="https://bundle.run/noble-secp256k1@1.2.14"></script>
    <script src="https://bundle.run/browserify-cipher@1.0.1"></script>
    <script src="./nostr.js"></script>
    <script src="./fhir.js"></script>
    <script src="./indexedDb.js"></script>
    <title>Patient Portal</title>
</head>

<body>
    <div id="myProfile" style="display: flex; flex-direction: column;">
    </div>
    <button id="sendPathologyReq">Request Glucose Exam</button>
    <div id="response"
        style="margin: 20px; padding: 20px; border: 1px solid black; border-radius: 10px; display: flex; flex-direction: column;">
        <h3>New Responses:</h3>
    </div>
    <div id="savedResponses"
        style="margin: 20px; padding: 20px; border: 1px solid black; border-radius: 10px; display: flex; flex-direction: column;">
        <h3>Saved Responses:</h3>
    </div>
</body>
<script>
    //////////////////////////////////////////////////////////////////////////
    //////////////////////////////////////////////////////////////////////////
    // Replace with a key generated by you
    // https://nak.nostr.com
    //////////////////////////////////////////////////////////////////////////
    var privKey = randomPrivKey();
    var pubKey = getPubKey(privKey);
    console.log(pubKey);
    var relay = "wss://relay.illuminodes.com";
    var socket = new WebSocket(relay);

    //////////////////////////////////////////////////////////////////////////
    //////////////////////////////////////////////////////////////////////////
    // Replace with your totally real patient details
    //////////////////////////////////////////////////////////////////////////
    var myFhirProfile = buildPatientResource(pubKey, "Alice", "+503 21212112", "alice@proton.com");
    profileDisplay = document.getElementById('myProfile');
    profileDisplay.innerHTML = myFhirProfile.text.div;

    //////////////////////////////////////////////////////////////////////////
    //////////////////////////////////////////////////////////////////////////
    // When the websocket opens we subscribe to the evens we are interested in
    //////////////////////////////////////////////////////////////////////////
    socket.addEventListener('open', async function (e) {
        console.log("connected to " + relay);

        var subId = randomSubId();
        // We will use ephemeral kinds (20000-29999) so relays do not save our data
        var filter = {"kinds": [20420], "#p": [pubKey]};

        var subscription = ["REQ", subId, filter]
        console.log('Subscription:', subscription);

        socket.send(JSON.stringify(subscription));
    });

    //////////////////////////////////////////////////////////////////////////
    //////////////////////////////////////////////////////////////////////////
    // When the button is clicked we send a request to the lab
    //////////////////////////////////////////////////////////////////////////
    var sendButton = document.getElementById('sendPathologyReq');
    sendButton.addEventListener('click', async function () {
        // Kind 82 as descibed in NIP-82 
        var fhirNote = {
            "content": JSON.stringify(myFhirProfile),
            "created_at": Math.floor(Date.now() / 1000),
            "kind": 82,
            "tags": [],
            "pubkey": pubKey,
        };
        var signedFhirData = await getSignedNote(fhirNote, privKey);
        console.log('signedEvent:', signedFhirData);

        // We giftwrap the data for the lab to maintain our privacy
        var fhirEncryptedData = encrypt(privKey, LAB_PUB_KEY, JSON.stringify(signedFhirData));
        var giftwrappedNote = {
            "content": fhirEncryptedData,
            "created_at": Math.floor(Date.now() / 1000),
            "kind": 20042,
            "tags": [["p", LAB_PUB_KEY]],
            "pubkey": pubKey,
        };
        var signedGiftwrappedNote = await getSignedNote(giftwrappedNote, privKey);
        console.log('giftwrappedNote:', signedGiftwrappedNote);

        // And we send the data to the lab
        socket.send(JSON.stringify(["EVENT", signedGiftwrappedNote]));
    });

    //////////////////////////////////////////////////////////////////////////
    //////////////////////////////////////////////////////////////////////////
    // We add a handler for incoming messages
    //////////////////////////////////////////////////////////////////////////
    socket.addEventListener('message', async function (message) {
        // Lets filter out relay specific events and only handle notes
        var [type, subId, note] = JSON.parse(message.data);
        var {kind, content} = note || {}
        if (!note || note === true) return;
        console.log('message:', note);

        // Lets make sure the note is of the kind we are interested in
        if (kind === 20420) {
            // we unwrap the giftwrapped data 
            decryptedData = await decrypt(privKey, note.pubkey, content);
            // and parse the note inside
            fhirSignedData = JSON.parse(decryptedData);

            // we can check the authenticity of the note author and its content
            var idOk = await verifyNoteId(fhirSignedData);
            var signatureOk = verifyNoteSignature(fhirSignedData);
            if (idOk && signatureOk) {
                console.log('FHIR data:', fhirSignedData);
                parsedFhirData = JSON.parse(fhirSignedData.content);
                var responseDiv = document.getElementById('response');
                // Lets display our results 
                responseDiv.innerHTML += `${parsedFhirData.text.div}`;
                // And save the data LOCALLY for future reference
                await storeObject(fhirSignedData);
            }

        }
    });

    //////////////////////////////////////////////////////////////////////////
    //////////////////////////////////////////////////////////////////////////
    // We load all saved responses from the local database
    //////////////////////////////////////////////////////////////////////////
    var savedResponsesDiv = document.getElementById('savedResponses');
    var savedResponse = getAllObjects().then(res => {
        res.forEach(response => {
            var parsedFhir = JSON.parse(response.content);
            savedResponsesDiv.innerHTML += `${parsedFhir.text.div}`;
        });
    });

</script>

</html>
